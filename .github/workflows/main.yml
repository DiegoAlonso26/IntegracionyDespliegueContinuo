name: ğŸš€ Docker Deploy Local con Self-Hosted Runner

on:
  push:
    branches:
      - main  # Cambia si usas otra rama

jobs:
  deploy:
    runs-on: self-hosted  # Esto hace que el runner se ejecute en tu PC local

    steps:
    - name: ğŸ§¾ Paso 1 - Descargar cÃ³digo del repo
      uses: actions/checkout@v3

    - name: ğŸ“ Paso 2 - Mostrar archivos descargados
      run: |
        echo "Contenido del directorio actual:"
        ls -la

    - name: ğŸ³ Paso 3 - Apagar contenedores anteriores (modo seguro)
      run: |
        echo "â¤ Intentando apagar contenedores anteriores..."
        timeout 20s docker compose down || echo "âš ï¸ No se apagÃ³ ningÃºn contenedor o se forzÃ³ salida"

    - name: âœ… Paso 3.5 - ConfirmaciÃ³n de avance
      run: echo "âœ”ï¸ Paso 3 terminado, seguimos con el build"

    - name: ğŸ§± Paso 4 - Construir contenedor
      run: |
        echo "â¤ Ejecutando docker compose build..."
        docker compose build

    - name: ğŸš€ Paso 5 - Levantar contenedor
      run: |
        echo "â¤ Ejecutando docker compose up..."
        docker compose up -d

    - name: ğŸ³ Paso 6 - Verificar contenedores activos
      run: |
        echo "â¤ Contenedores en ejecuciÃ³n:"
        docker ps

    - name: ğŸ“„ Paso 7 - Mostrar logs del contenedor (opcional)
      run: |
        echo "â¤ Logs del contenedor (Ãºltimos 20 segundos):"
        docker logs $(docker ps -q) --since 20s || echo "âš ï¸ No hay logs disponibles"
